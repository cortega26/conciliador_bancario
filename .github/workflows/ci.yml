name: ci
permissions:
  contents: read

on:
  pull_request:
  push:
    branches: ["main"]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install
        run: |
          python -m pip install -U pip
          pip install -e ".[dev]"

      - name: Format (black)
        run: python -m black --check src tests tools

      - name: Lint (ruff)
        run: python -m ruff check src tests tools

      - name: Security (bandit)
        run: python -m bandit -c .bandit.yml -r src

      - name: Security (semgrep)
        run: |
          docker run --rm -v "$(pwd):/src" -w /src returntocorp/semgrep:1.95.0 \
            semgrep scan --config .semgrep.yml --error --metrics=off src

      - name: Supply chain (pip-audit)
        run: python tools/pip_audit_gate.py

      - name: Tests
        run: python -m pytest -q

      - name: Build (sdist + wheel)
        run: python -m build

      - name: Verify dist (twine check)
        run: python -m twine check dist/*

  wheel_smoke:
    runs-on: ubuntu-latest
    needs: [test]
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Build wheel
        run: |
          python -m pip install -U pip
          python -m pip install build==1.2.2
          python -m build

      - name: Install-from-wheel smoke
        run: |
          python -m venv .smoke_venv
          .smoke_venv/bin/python -m pip install -U pip
          .smoke_venv/bin/pip install dist/*.whl
          .smoke_venv/bin/python -c "import bankrecon as br; import conciliador_bancario as cb; from conciliador_bancario.core import premium_contracts as pc; print(br.__version__); assert br.__version__ == cb.__version__; assert pc.RUN_JSON_SCHEMA_VERSION"
          .smoke_venv/bin/concilia --help

  release:
    # Regla operacional: cada push a main (con CI verde) debe producir un bump de version + tag.
    # Esto evita que se "olvide" el bump y rompa publicaciones a PyPI por versiones repetidas.
    if: >-
      ${{
        github.event_name == 'push' &&
        github.ref == 'refs/heads/main' &&
        !startsWith(github.event.head_commit.message, 'chore(release):')
      }}
    runs-on: ubuntu-latest
    needs: [test, wheel_smoke]
    permissions:
      contents: write
    concurrency:
      group: release-main
      cancel-in-progress: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Guard (only tip of main)
        id: guard
        run: |
          HEAD_SHA="$(git rev-parse HEAD)"
          MAIN_SHA="$(git rev-parse origin/main)"
          if [ "$HEAD_SHA" != "$MAIN_SHA" ]; then
            echo "Not releasing: this CI run is not the current tip of main."
            echo "head=$HEAD_SHA"
            echo "main=$MAIN_SHA"
            echo "proceed=false" >> "$GITHUB_OUTPUT"
          else
            echo "proceed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        if: steps.guard.outputs.proceed == 'true'
        with:
          python-version: "3.11"

      - name: Install
        if: steps.guard.outputs.proceed == 'true'
        run: |
          python -m pip install -U pip
          pip install -e ".[dev]"

      - name: Supply chain (pip-audit)
        if: steps.guard.outputs.proceed == 'true'
        run: python tools/pip_audit_gate.py

      - name: Bump patch (bump2version)
        if: steps.guard.outputs.proceed == 'true'
        run: bump2version patch

      - name: Read new version
        id: ver
        if: steps.guard.outputs.proceed == 'true'
        run: |
          VERSION="$(python -c 'import sys; sys.path.insert(0, "src"); from conciliador_bancario.version import __version__; print(__version__)')"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Ensure tag does not already exist (fail-closed)
        if: steps.guard.outputs.proceed == 'true'
        run: |
          if git show-ref --tags --verify --quiet "refs/tags/v${{ steps.ver.outputs.version }}"; then
            echo "Tag v${{ steps.ver.outputs.version }} already exists; refusing to overwrite."
            exit 1
          fi

      - name: Update CHANGELOG (move Unreleased)
        if: steps.guard.outputs.proceed == 'true'
        run: python tools/bump_changelog.py --version "${{ steps.ver.outputs.version }}"

      - name: Commit + Tag
        if: steps.guard.outputs.proceed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add src/conciliador_bancario/version.py .bumpversion.cfg CHANGELOG.md
          git commit -m "chore(release): v${{ steps.ver.outputs.version }} [skip release]"
          # Use an annotated tag so `git push --follow-tags` reliably pushes it.
          git tag -a "v${{ steps.ver.outputs.version }}" -m "v${{ steps.ver.outputs.version }}"

      - name: Push
        if: steps.guard.outputs.proceed == 'true'
        run: git push origin HEAD:main --follow-tags
